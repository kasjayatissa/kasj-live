"use strict";(self.webpackChunkkasj_live=self.webpackChunkkasj_live||[]).push([[7743],{3905:(e,t,a)=>{a.d(t,{Zo:()=>u,kt:()=>k});var n=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function l(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?l(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},l=Object.keys(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},u=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},c="mdxType",f={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,l=e.originalType,s=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),c=p(a),m=r,k=c["".concat(s,".").concat(m)]||c[m]||f[m]||l;return a?n.createElement(k,i(i({ref:t},u),{},{components:a})):n.createElement(k,i({ref:t},u))}));function k(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=a.length,i=new Array(l);i[0]=m;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o[c]="string"==typeof e?e:r,i[1]=o;for(var p=2;p<l;p++)i[p]=a[p];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}m.displayName="MDXCreateElement"},3276:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>f,frontMatter:()=>l,metadata:()=>o,toc:()=>p});var n=a(7462),r=(a(7294),a(3905));const l={slug:"traefik",title:"Cluster reverse proxy",authors:["kas"],tags:["reverse-proxy","traefik","kubernetes"]},i="Reverse proxy for K3s cluster",o={permalink:"/kasj-live/blog/traefik",source:"@site/blog/2023-02-13-traefik/index.md",title:"Cluster reverse proxy",description:"Now that I have load balancer to expose my services externally, I have a couple of options:",date:"2023-02-13T00:00:00.000Z",formattedDate:"February 13, 2023",tags:[{label:"reverse-proxy",permalink:"/kasj-live/blog/tags/reverse-proxy"},{label:"traefik",permalink:"/kasj-live/blog/tags/traefik"},{label:"kubernetes",permalink:"/kasj-live/blog/tags/kubernetes"}],readingTime:2.065,hasTruncateMarker:!1,authors:[{name:"Kas J",title:"Author",url:"https://github.com/kasjayatissa",imageURL:"https://avatars.githubusercontent.com/u/90017589?v=4",key:"kas"}],frontMatter:{slug:"traefik",title:"Cluster reverse proxy",authors:["kas"],tags:["reverse-proxy","traefik","kubernetes"]},prevItem:{title:"Certificates for HTTPS",permalink:"/kasj-live/blog/certs"},nextItem:{title:"Cluster load balancer",permalink:"/kasj-live/blog/metallb"}},s={authorsImageUrls:[void 0]},p=[{value:"Installing Traefik",id:"installing-traefik",level:2},{value:"Verifying installation",id:"verifying-installation",level:2}],u={toc:p},c="wrapper";function f(e){let{components:t,...l}=e;return(0,r.kt)(c,(0,n.Z)({},u,l,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"Now that I have load balancer to expose my services externally, I have a couple of options:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Expose every service I deploy over metallb (ie. each app gets its own IP address) or;"),(0,r.kt)("li",{parentName:"ul"},"Deploy a ",(0,r.kt)("strong",{parentName:"li"},"reverse proxy")," which intercepts and routes every incoming request to the corresponding backend services.")),(0,r.kt)("p",null,"From the title, you can tell which option I went with. I went with the reverse proxy option because"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"I don't know how many applications I will eventually host"),(0,r.kt)("li",{parentName:"ul"},"I also don't need to think about which application is associated with which IP and configure DNS routes etc"),(0,r.kt)("li",{parentName:"ul"},"It can also provide SSL termination and can be used with an ACME provider (like Let\u2019s Encrypt) for automatic certificate generation (which I'll cover in a future post)")),(0,r.kt)("h2",{id:"installing-traefik"},"Installing Traefik"),(0,r.kt)("p",null,"Like Metallb, there are heaps of reverse proxy options out there but I went with a popular option ",(0,r.kt)("a",{parentName:"p",href:"https://traefik.io/traefik/"},"Traefik"),"."),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://traefik.io/static/83ea42c9e8101dcf2a16f380fe3aac08/053ba/diagram.webp",alt:"traefik"})),(0,r.kt)("p",null,"I wanted to try installing this via helm this time. Helm allows you specify custom configuration values via a ",(0,r.kt)("inlineCode",{parentName:"p"},"values.yaml")," file so I did that first. I know its quite long but I just tweaked the defaults:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="values.yaml"',title:'"values.yaml"'},'globalArguments:\n  - "--global.sendanonymoususage=false"\n  - "--global.checknewversion=false"\n\nadditionalArguments:\n  - "--serversTransport.insecureSkipVerify=true"\n  - "--log.level=INFO"\n\ndeployment:\n  enabled: true\n  replicas: 1\n  annotations: {}\n  podAnnotations: {}\n  additionalContainers: []\n  initContainers: []\n\nports:\n  web:\n    redirectTo: websecure\n  websecure:\n    tls:\n      enabled: true\n\ningressRoute:\n  dashboard:\n    enabled: false\n\nproviders:\n  kubernetesCRD:\n    enabled: true\n    ingressClass: traefik-external\n    allowExternalNameServices: true\n  kubernetesIngress:\n    enabled: true\n    allowExternalNameServices: true\n    publishedService:\n      enabled: false\n\nrbac:\n  enabled: true\n\nservice:\n  enabled: true\n  type: LoadBalancer\n  annotations: {}\n  labels: {}\n  spec:\n    loadBalancerIP: 192.168.86.100 # this should be an IP in the MetalLB range\n  loadBalancerSourceRanges: []\n  externalIPs: []\n')),(0,r.kt)("p",null,"Then I needed to execute these commands to install via helm (after installing ",(0,r.kt)("a",{parentName:"p",href:"https://helm.sh/"},"helm")," of course):"),(0,r.kt)("p",null,"Add repo"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"helm repo add traefik https://helm.traefik.io/traefik\n")),(0,r.kt)("p",null,"Update repo"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"helm repo update\n")),(0,r.kt)("p",null,"Create namespace"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl create namespace traefik\n")),(0,r.kt)("p",null,"Finally install using helm and our custom values file:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"helm install --namespace=traefik traefik traefik/traefik --values=values.yaml\n")),(0,r.kt)("h2",{id:"verifying-installation"},"Verifying installation"),(0,r.kt)("p",null,"Finally it was time to check if installation succeeded. "),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"traefikverify",src:a(6806).Z,width:"1213",height:"311"})),(0,r.kt)("p",null,"What a beautiful sight, it is all working. The main thing I was happy to see was that Metallb did the job too by assigning the IP ",(0,r.kt)("inlineCode",{parentName:"p"},"192.168.86.100")," to the traefik service. This means I can now route all incoming request (regardless of which application) to this IP and traefik will handle all the routing. This will be done through domain names which will be covered in a later post."))}f.isMDXComponent=!0},6806:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/traefikverify-8ffda3e0f704c78af7aa5f7458b19fdf.png"}}]);